name: Check Signed Commits

on:
  workflow_call:

jobs:
  check-signatures:
    name: Verify Commit Signatures
    runs-on: ubuntu-latest
    steps:
      - name: Check for unsigned commits
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Exit on error, undefined vars, and pipe failures (ensures failures in piped commands like `jq | head` are caught)
          set -euo pipefail

          echo "::group::Fetching PR commits"
          echo "Repository: ${{ github.repository }}"
          echo "PR Number: ${{ github.event.pull_request.number }}"
          commits=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/commits --paginate)
          commit_count=$(echo "$commits" | jq length)
          echo "Found $commit_count commits in PR"
          echo "::endgroup::"

          echo "::group::Commit verification status"
          echo "$commits" | jq -r '.[] | "  \(.sha[0:7]) | verified: \(.commit.verification.verified) | \(.commit.message | split("\n")[0])"'
          echo "::endgroup::"

          # Find unsigned commits
          unsigned=$(echo "$commits" | jq -r '.[] | select(.commit.verification.verified == false) | "- `\(.sha[0:7])` \(.commit.message | split("\n")[0])"')
          unsigned_count=$(echo "$commits" | jq '[.[] | select(.commit.verification.verified == false)] | length')

          echo "::group::Signature summary"
          echo "Total commits: $commit_count"
          echo "Unsigned commits: $unsigned_count"
          echo "::endgroup::"

          if [ -n "$unsigned" ]; then
            echo "::error::Found $unsigned_count unsigned commits in this PR"
            echo ""
            echo "Unsigned commits:"
            echo "$unsigned"

            # Build comment body
            comment_body="⚠️ **Unsigned Commits Detected**

          The following commits are not signed:
          $unsigned

          Please sign your commits before merging. See [GitHub's guide on signing commits](https://docs.github.com/en/authentication/managing-commit-signature-verification/signing-commits)."

            echo "::group::Checking for existing bot comment"
            existing_comment=$(gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments --paginate | \
              jq -r '.[] | select(.user.login == "github-actions[bot]" and (.body | contains("Unsigned Commits Detected"))) | .id' | head -1)
            echo "Existing comment ID: ${existing_comment:-none}"
            echo "::endgroup::"

            if [ -n "$existing_comment" ]; then
              echo "Updating existing comment (ID: $existing_comment)..."
              gh api repos/${{ github.repository }}/issues/comments/$existing_comment \
                --method PATCH \
                -f body="$comment_body"
              echo "Updated existing comment"
            else
              echo "Creating new comment..."
              gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
                -f body="$comment_body"
              echo "Created new comment"
            fi

            exit 1
          else
            echo "All $commit_count commits are signed ✓"

            echo "::group::Checking for outdated bot comment to remove"
            existing_comment=$(gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments --paginate | \
              jq -r '.[] | select(.user.login == "github-actions[bot]" and (.body | contains("Unsigned Commits Detected"))) | .id' | head -1)
            echo "Existing comment ID: ${existing_comment:-none}"
            echo "::endgroup::"

            if [ -n "$existing_comment" ]; then
              echo "Removing outdated comment (ID: $existing_comment)..."
              gh api repos/${{ github.repository }}/issues/comments/$existing_comment --method DELETE
              echo "Removed outdated unsigned commits comment"
            fi
          fi
